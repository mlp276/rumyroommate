<!DOCTYPE html>
<html>
<body>

<h2>RU My Roommate?</h2>
<h3>Main Page</h3>

<label for='netid'>Let the userid of this logged account be:</label><br>
<input type='text' id='netid' name='netid'><br><br>

<p id='userpreferences'></p>

<button id='listingsButton' onclick='buttonEvent()'>Get Listings</button><br>

<p>Filter by Preferences:
<select id='preferences'>
    <option value=0>None</option>
    <option value=1>Gender</option>
    <option value=2>Major</option>
    <option value=3>Preferred Race</option>
    <option value=4>Preferred Religion</option>
    <option value=5>Smoking Preferences</option>
    <option value=6>Drinking Preferences</option>
    <option value=7>Sleep Habits</option>
    <option value=15>Preferred Low Temperature</option>
    <option value=16>Preferred High Temperature</option>
    <option value=17>Preferred Guest Frequency</option>
    <option value=18>Cleanliness Level</option>
    <option value=19>Noise Tolerance Level</option>
</select>
</p>

<pre id='jsonError'></pre>
<pre id='jsonResult'></pre>
<p id='demo'></p>

<script>
async function buttonEvent() {
    displayPreferences();
    displayListings();
}

async function displayPreferences() {
	const userid = document.getElementById('netid').value;
    const preferenceid = document.getElementById('preferences').value;

    let text = `Preferences of ${userid}:<br>`;
    try {
        let response, json;
        for (let preferenceid = 1; preferenceid < preferenceIDs.length; ++preferenceid) {
            response = await fetch(`http://localhost:8080/preferences?userid=${userid}&preferenceid=${preferenceid}`);
            if (response.ok) {
                json = await response.json();
            }
            else {
                const errorText = await response.text();
                throw Error(`${response.status} ${response.statusText}: ${errorText}`);
            }

            const preference = json.preference;
            text += `${getPreferenceColumn(preferenceid)}: ${preference}<br>`;
        }

        document.getElementById('userpreferences').innerHTML = text;
    }
    catch (error) {
        document.getElementById('jsonError').innerHTML = error.toString();
        return;
    }
}
    
/* List of implemented preferences and their associated ids */
const preferenceIDs = [
    null,
    'gender',
    'major',
    'prefrace',
    'prefreligion',
    'prefsmoking',
    'prefdrinking',
    'sleephabits',
    'sleepstarttime',
    'sleependtime',
    'studystarttime',
    'studyendtime',
    'sharedstarttime',
    'sharedendtime',
    'roombudget',
    'preflowtemp',
    'prefhightemp',
    'prefguestfreq',
    'cleanliness',
    'noisetolerance'
];

const getPreferenceColumn = function (preferenceid) {
    /* Check that the preference id is within the valid range */
    if (preferenceid < 0 || preferenceid >= preferenceIDs.length) {
        throw Error('Preference id Out of Range');
    }

    return preferenceIDs[preferenceid];
};

async function displayListings() {
    document.getElementById('jsonError').innerHTML = '';

	const userid = document.getElementById('netid').value;
    const preferenceid = document.getElementById('preferences').value;

    let json;
    try {
        json = await searchListings(userid, preferenceid);
        // document.getElementById('jsonResult').innerHTML = JSON.stringify(json, null, 2);
    }
    catch (error) {
        document.getElementById('jsonError').innerHTML = error.toString();
        return;
    }

    /* Neatly display the listings in a table*/
    try {
        let text = '<table border=1>';

        let matched_listings = json.matched_listings;
        if (matched_listings.length === 0) {
            document.getElementById('demo').innerHTML = 'No matching listings found.';
            return;
        }

        for (const listing of json.matched_listings) {
            text += '<tr><td>' + await listingText(listing) + '</td></tr>';
        }
        text += '</table>';
        document.getElementById('demo').innerHTML = text;
    }
    catch (error) {
        document.getElementById('jsonError').innerHTML = error.toString();
    }
}

async function searchListings(userid, preferenceid) {
	if (userid.length === 0) {
        throw Error('Bad userid');
    }

    const response = await fetch(`http://localhost:8080/listings/search?userid=${userid}&preferenceid=${preferenceid}`);
    if (response.ok) {
        const json = await response.json();
        return json;
    }
    else {
        const errorText = await response.text();
        throw Error(`${response.status} ${response.statusText}: ${errorText}`);
    }
}

async function listingText(listing) {
    let text = '<p>';
    
    const listing_userid = listing.userid;
    const listing_preferenceids = listing.preferenceids.split(',');
    const listing_address = listing.address;

    let response, json;

    let netid;
    response = await fetch(`http://localhost:8080/accounts?userid=${listing_userid}`);
    if (response.ok) {
        json = await response.json();
        netid = json.account.netid;
        text += `<b>Netid</b>: ${netid}<br>`;
    }
    else {
        const errorText = await response.text();
        throw Error(`${response.status} ${response.statusText}: ${errorText}`);
    }

    text += `<b>Preferences</b>:<br>`;
    for (const listing_preferenceid of listing_preferenceids) {
        response = await fetch(`http://localhost:8080/preferences?userid=${listing_userid}&preferenceid=${listing_preferenceid}`);
        if (response.ok) {
            json = await response.json();
            preference = json.preference;
        }
        else {
            const errorText = await response.text();
            throw Error(`${response.status} ${response.statusText}: ${errorText}`);
        }

        text += `${getPreferenceColumn(listing_preferenceid)}: ${preference}<br>`;
    }

    text += `<b>Address</b>: ${listing_address}<br>`;
    return text;
}
</script>

</body>
</html>
